---
title: "Evaluations of positive and negative stimuli using the Affective Misattribution Procedure (AMP) and self-reports"
subtitle: "Data processing"
author: "Template: Ian Hussey; content: [Student name]"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

# TODO

- Add data processing
- Combine data frames
- Save to disk

```{r, include=FALSE}

knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

```

# Dependencies

```{r}

library(tidyverse)
library(janitor) # for clean_names()
library(stringr)

```

# Get data

```{r}

# demographics
data_demographics_raw <- read_csv("../../../data/AMP study/raw/data_demographics_raw.csv") |>
  janitor::clean_names()

data_demographics_raw_messy <- read_csv("../../../data/AMP study/raw/data_demographics_raw_messy.csv", skip = 2) |>
  janitor::clean_names()

# self report measure
data_selfreport_raw <- read_csv("../../../data/AMP study/raw/data_selfreport_raw.csv") |>
  janitor::clean_names()

# affect attribution procedure
data_amp_raw <- read_csv("../../../data/AMP study/raw/data_amp_raw.csv") |>
  janitor::clean_names()

```

```{r}

# dat <- data_demographics_raw_messy |>
#   filter(!trial_code %in% c("prolific ID", "psychiatric diagnosis")) |>
#   select(subject, date, time, trial_code, key_response)



```


# Demographics

TODO extract age and gender data into wide format

## Option 1

```{r}

dat <- data_demographics_raw |>
  select(subject, date, time, trialcode, response)

dat_gender <- dat |>
  filter(trialcode == "gender") |>
  rename(gender = response) |>
  mutate(gender = tolower(gender),
         # regex is useful and awful
         gender = stringr::str_remove_all(gender, regex("\\W+")),
         gender = case_when(gender == "female" ~ gender,
                            gender == "male" ~ gender,
                            gender == "nonbinary" ~ gender,
                            gender == "woman" ~ "female",
                            gender == "man" ~ "male",
                            TRUE ~ "other/missing/error")) |>
  select(-trialcode)

dat_gender |>
  count(gender)

dat_age <- dat |>
  filter(trialcode == "age") |>
  rename(age = response) |>
  mutate(age = as.numeric(age),
         age = ifelse(is.na(age), "other/missing/error", age)) |>
  select(-trialcode)

dat_age |>
  count(age)

dat_age_gender <- 
  full_join(dat_age, 
            dat_gender,
            by = c("subject", "date", "time"))

```

## Option 2

```{r}

dat_wide <- dat |>
  pivot_wider(names_from = trialcode,
              values_from = response)

```

# Exclusions / data quality

## AMP

```{r}

data_performance_criteria <- data_amp_raw |> 
  filter(blockcode != "practice", 
         trialcode != "instructions") |> 
  mutate(latency_prob = if_else(latency < 100, TRUE, FALSE)) |> 
  group_by(subject) |> 
  summarize(proportion_fast_trials_amp = mean(latency_prob))

```



# Self-reports

TODO extract self-reported evaluations and convert to a sum score

```{r}

data_selfreport <- data_selfreport_raw |>
  select(time, subject, trialcode, response) |>
  filter(trialcode %in% c("like", "prefer", "positive")) |>
  rename(item = trialcode) |>
  filter(response != "Ctrl+'B'") |>
  mutate(response = as.numeric(response))

data_selfreport_mean <- data_selfreport |>
  group_by(subject) |>
  summarize(mean_evaluation = mean(response, na.rm = TRUE))



# data_selfreport_mean2 <- data_selfreport |>
#   summarize(mean_evaluation = mean(response, na.rm = TRUE), 
#             .by = subject)

# if code isn't working, step one is often to check what class your variables are
lapply(data_selfreport, class)



# data_selfreport_wide <- data_selfreport |>
#   pivot_wider(names_from = "item",
#               values_from = "response")
#
# data_selfreport <- 
#   full_join(data_selfreport_wide,
#             data_selfreport_mean,
#             by = "subject")

data_selfreport_combined <- 
  full_join(data_selfreport |>
              pivot_wider(names_from = "item",
                          values_from = "response"),
            data_selfreport_mean,
            by = "subject")


```

# Affect Misattribution Procedure

TODO extract evaluations on the AMP test blocks and convert to an overall bias score

```{r}


```

# Combine

TODO combine demographics, self-reports and AMP into a single data frame in wide format, i.e., the processed data

```{r}

data_processed_temp <- 
  full_join(dat_age_gender,
            data_selfreport_combined,
            by = "subject") |> 
  full_join(data_performance_criteria, by = "subject")

data_processed_duplicates <- data_processed_temp |>
  count(subject) |>
  mutate(exclude_duplicate_data = if_else(n > 1, "exclude", "include")) |>
  select(-n)

data_processed <- 
  full_join(data_processed_temp,
            data_processed_duplicates,
            by = "subject")

```

# Define master exclusions

```{r}



data_processed_with_master_exclusions <- data_processed |>
  mutate(exclude_participant = case_when(tolower(age) == "test" ~ "exclude",
                                         tolower(gender) == "test" ~ "exclude",
                                         proportion_fast_trials_amp > .10 ~ "exclude",
                                         exclude_duplicate_data == "exclude" ~ "exclude",
                                         TRUE ~ "include"))


```

# Write to disk

TODO write the processed data to disk

```{r}

# in case this dir doesn't exist, create it
dir.create("../../../data/AMP study/processed/")

# save data to disk in that dir
write_csv(data_processed,
          "../../../data/AMP study/processed/data_processed.csv")

```

# Session info

```{r}

sessionInfo()

```


